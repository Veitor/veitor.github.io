---
title: 基于多租户和helm的灰度发布策略的思考
tags:
  - 运维
  - 架构
categories:
  - 架构
date: 2021-11-23 17:19:15
---

先简单介绍一下我司的背景情况。我司是做的SaaS服务相关的业务，且该业务与常见的SaaS服务有所不同，我们交付给客户的是一个平台型产品，相当于客户自己拥有了一个网站平台。所以我们产品类型类似于`to B to C`型或`to B to B`的，我们直接服务于大B客户，而同时也要兼顾大B的运营、to C或to小B的模式。

在技术上，采用k8s集群部署应用，通过Helm进行应用发布。日常小功能的迭代、问题的处理等都是直接`helm upgrade`方式进行滚动发布并上线，对我们租户的使用基本不会产生影响。

对于大改版、大更新的应用上线，尽管进行了一定的测试，但也有很大的不确定性，我们需要采用类似灰度发布的形式进行上线，并且能够满足如下要求：

1. 由于业务产品特性，我们需要以租户为单位和控制粒度进行流切，将租户的平台流量均切换到新部署的应用上。
2. 新旧版本应用将保持同时运行一段时间，这个时间与常规的灰度发布所需要的时间（可能几个小时）有所不同，我们可能需要几天甚至一两周时间来逐步将一些租户切流到新版本上。
3. 灰度发布期间，新旧两个版本的应用可能还需要进行一些bug的修复或功能的修改等，需要相互不影响且能进行再次更新。

就上面的要求，进行思考。

> 如何实现多版本应用同时运行？

由于目前我们的整体技术架构并不是很先进的微服务架构，但也有一点类似的样子，只不过服务非常少，因此可以先仅仅看作是一个简单的单体应用架构。所以这么看来，对于发布一个新版本应用，只是涉及单个应用的发布和更新，并不涉及一连串的服务也要同时发布更新。因此看起来通过Helm Chart可以有这几种实现方式：

1. 在一个Chart中编排新旧两个版本应用及其相关的资源，部署和更新时对必要的`values`参数做修改，仅仅需要对一个`Release`做一些`helm upgrade`的操作。
2. 在一个Chart中仅编排一个应用及其相关的资源，对新旧不同版本分别做`helm install`发布得到两个新旧版本的`Release`。

就