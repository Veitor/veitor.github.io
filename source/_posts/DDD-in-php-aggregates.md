---
title: '[译]聚合 - 《Domain-Driven Design in PHP》第8章'
tags:
  - ddd
  - 领域驱动设计
categories:
  - PHP
date: 2020-05-25 21:59:36
---

> 本篇博文由本博客(`http://www.veitor.net`)经原文翻译，转载请注明出处。

聚合可能是领域驱动设计中最困难的构建块。它们很难理解，甚至难以正确设计。但是不用担心，我们在这里给你提供帮助。在进入聚合之前，我们需要先了解一些关键概念：事务和并发策略。

介绍
---

如果你的工作与电子商务应用有关，你可能会遇到过与你数据库数据不一致有关的问题。例如，一个购物订单的总金额为99.99美元，但该订单总金额与订单中每项金额之和89.99美元不匹配，那额外的10美元从哪里来的？

或者，思考一个影院售票网站的例子。有一个拥有100个座位的电影院，在电影上映时每个人都在网站上等待购买电影票，一旦你开始进行销售，电影票会迅速一抢而空，但最终你以某种方式售卖出了102张座位。你可能指定了只有100个座位，但由于某种原因还是超过了这个阈值。

你可能有过使用JIRA或Redmine等协作系统的经验。考虑一下由开发人员、QA人员和产品负责人组成的团队，如果每个人都在对User Story进行分类和拖动转移，然后再保存，会发生什么？最终的User story优先级将是团队成员中最后保存那个人的。

通常，我们以费原子方式处理持久机制时，就会出现数据不一致的情况。例如，当你想数据库发送三个查询时，其中一些查询结果有效，而一些无效。数据库的最终状态不一致。有时，你希望这三个查询一起成功或失败，而这可以通过事务来解决。但是，请小心，如你在本章中看到的那样，并非所有不一致都通过事务来解决。实际上，有时其他数据不一致需要锁定或者使用并发策略。这些工具可能会影响你的应用程序性能，因此请注意进行权衡。

你可能会认为这类数据不一致仅发生在数据库中，但事实并非如此。例如，我们使用面向文档的数据库（如Elasticsearch），则两个文档之间的数据库可能会不一致。此外，大多数NoSQL持久性存储系统都不支持ACID事务。这意味着你不能在单个操作中持久化或者更新多个文档。因此，如果我们对Elasticsearch发出不同的请求，则可能失败，从而持久保存在Elasticsearch中的数据不一致。

保持数据一致是一个挑战。不要将基础设施问题泄漏到领域中是个更大的挑战。聚合的目的是在帮助你完成这两件事的。

关键概念
---

持久化引擎（尤其是数据库）具有一些解决数据不一致的功能：ACID、约束、参照完整性、锁定、并发控制和事务。在使用聚合之前，让我们回顾一下这些概念。

这些概念大多数都在网上公开，我们要改写Oracle、PostgreSQL和Doctine的人员在其文档方面所作出的贡献。他们精心定义和解释了这些重要的术语，而不是重新发明轮子，我们整理了一些官方的解释与你分享。


（译者注：这里省略掉原文摘自数据库官网关于数据库事务的原文翻译，关于数据库事务的知识建议单独寻找相关的知识点进行查阅，或直接查看原文）

什么是聚合？
---

聚合是持有其他实体和值对象的实体，有助于保持数据一致性。Vaughn Vernon的《Implementing Domain-Driven Design》：

> 聚合是精心制作的将实体和值对象聚在一起的一致性边界。

Pramod J. Sadalage和Martin Fowler《NoSQL Distilled: A Brief Guide to the Emerging World of Polyglot Persistence》一书说到：

> 在领域驱动设计中，聚合是我们希望视为一个单元的相关对象的集合。特别是，它是用于数据操作和一致性管理的单元。通常，我们喜欢使用原子操作来更新聚合，并根据聚合与我们的数据存储进行通信。

####  Martin Fowler说了什么

来自http://martinfowler.com/bliki/DDD_Aggregate.html：

> 聚合是领域驱动设计中的一种模式。一个DDD聚合是领域对象的集合，可以将它们视为一个单元。一个示例可能是一个订单及其订单项，它们都是单独的对象，但是将订单（连通订单项）作为单个聚合很有用。
> 
> 聚合将它的组成对象之一变成聚合根，任何外部对聚合的引用都应该只能达到聚合根。聚合根可以确保整个聚合的完整性。
> 
> 聚合是你请求加载或保存整个聚合的数据存储传输的基本元素，事务不应该跨越聚合边界。
> 
> DDD聚合又是会与类的集合（如lists列表、maps映射表）混淆。DDD聚合是领域概念（订单、播放列表），然而集合是通用的。聚合通常包含多个集合以及简单的字段。术语“aggregate”是一个常见的术语，在各种不同的上下文中使用（如XML），在这种情况下，它与DDD聚合所引用的概念不同。（译者注：这里的aggregate并不是指的领域中的聚合的意思）